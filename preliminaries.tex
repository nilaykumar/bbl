\chapter{Preliminaries}

\blurb{We begin with a review of derivations and differential operators in the local case. 
    We then introduce the sheaf $\mathscr{D}_X$ and study basic properties of $\mathscr{D}_X$-modules.}

\section{Basic constructions}

\subsection{Differential operators}

\begin{definition}
    We say that a commutative ring $R$ is \textbf{affine} if it is
    the coordinate ring of an affine complex algebraic variety, i.e.
    if $R$ is an integral domain of finite type over $\C$.
\end{definition}

\begin{definition}
    Let $R$ be affine, and $M,N$ two $R$-modules.\sidenote{The affine condition is not strictly necessary
    for many of our definitions,
    but it will be useful when working over complex algebraic varieties.}
    We define the module of
    differential operators $\Diff_R(M,N)$ from $M$ to $N$ to be the homomorphisms $d\in\Hom_\C(M,N)$
    such that there exists an $k\in\N$ with any set of $k+1$ elements of $R$ satisfying
    \begin{equation}
        (\ad r_0)(\ad r_1)\cdots(\ad r_k)(d)=0,
        \label{eq:ad}
    \end{equation}
    where $(\ad r)(d)=[r,d]=rd-dr$. In this case, we say that $d$ is of order $\leqslant k$.
    Note that the submodule of differential operators of order $\leqslant 0$, in particular,
    is simply $\Hom_R(M,N)$. We will write $D(R)$ for the module $\Diff_R(R,R)\subset\End_{\C}(R,R)$.
    \label{def:derivations}
\end{definition}

\begin{remark}
    The order of a differential operator provides a natural filtration of the module $\Diff_R(M,N)$.
    This yields the following inductive definition of $\Diff_R(M,N)$, equivalent to the one
    above\sidenote{In this formulation, these are typically known as Grothendieck differential
    operators.}: % TODO should we mention the other definition using im(R->Hom(M,N))?
    \begin{enumerate}
        \item[] $\Diff^{i}_R(M,N) = 0; \;\;\;(i<0)$
        \item[] $\Diff^k_R(M,N) = \{u\in\Hom_\C(M,N)\mid (\ad r)(u)\in \Diff^{k-1}_R(M,N)\};$
        \item[] $\Diff_R(M,N)=\bigcup_k\Diff^k_R(M,N)$.
    \end{enumerate}
\end{remark}

\begin{lemma}
    The module $D(R)=\Diff_R(R,R)$ forms a filtered ring under composition of
    differential operators. Moreover, if $P\in D^j(R), Q\in D^k(R)$, then $[P,Q]\in D^{j+k-1}(R)$.
    \label{lem:filtration}
\end{lemma}
\begin{proof}
    That $D(R)$ forms a ring is clear; it suffices to show that $D^i(R)\cdot D^j(R)\subset D^{i+j}(R)$.
    If we have $\alpha\in D^i(R),\beta\in D^j(R),r\in R$, then
    \[ [\alpha\beta,r] = \alpha\beta r-r\alpha\beta = \alpha[\beta,r] +[\alpha,r]\beta.  \]
    Now $[\alpha,r]$ is of order $\leqslant (i-1)$ and $[\beta,r]$ is of order $\leqslant(j-1)$, so induction
    yields the case of degree $i$ times an $R$-linear endomorphism $f$ (of degree zero). Now
    \[ [\alpha f, r]=\alpha fr-r\alpha f=\alpha rf-r\alpha f=[\alpha,r]f, \]
    so another induction yields the case of the product two $R$-linear endomorphisms, which is another
    $R$-linear endomorphism, hence degree $0$.

    Now consider $[P,Q]$ -- the Jacobi identity (or using the first equation above twice) yields
    \[ [[P,Q],r] = [P,[Q,r]] - [Q,[P,r]].\]
    We induct twice as above. Then $[ [P,Q], r]$ has the same order as $[P, [Q, r]]$,
    which by the induction hypothesis is $j+k-2$. Hence $[P,Q]$ is of order $\leqslant j+k-1$.
\end{proof}

\begin{definition}
    Let $M$ be an $R$-module. Recall that $\Der_\C(R,M)$ is the (left) $R$-module of $\C$-module homomorphisms
    $\delta:R\to M$ satisfying the product rule $\delta(rs)=r\delta(s)+\delta(r)s.$
    The \textbf{derivation ring} $\Delta(R)$ of $R$ is the subring of $\End_\C(R,R)$ generated
    by $R$ and $\Der_\C(R,R)$.
\end{definition}

\begin{lemma}
    The derivation ring $\Delta(R)$, under the filtration where $\Delta^i(R)$ is the
    $R$-submodule generated by all products of at most $i$ derivations, is a filtered
    subring of the ring of differential operators $D(R)$.
    \label{lemma:filtsubring}
\end{lemma}
\begin{proof}
    It is clear that $\Delta^i(R)\cdot\Delta^j(R)\subset\Delta^{i+j}(R)$,\sidenote{In fact,
    we have equality.} so the filtration on $\Delta(R)$ is well-defined. It remains to show
    that $[\Delta^i(R),r]\subset\Delta^{i-1}(R)$. We proceed inductively: the result clearly
    holds for $i=0$. Now suppose it holds for some $i-1$ and let $d\in\Delta^{i}(R)$. Assume,
    without loss of generality, that we can write $d=d_1\cdots d_i$ with each
    $d_j\in\Der_\C(R)$.\sidenote{In general, $\Delta^i(R)$ is a sum of terms
    each with a product of a different number $\leqslant i$ of derivations.
    We can drop all terms with fewer than $i$ derivations by the induction step.}
    Then, for $r,s\in R$, we find that
    \begin{align*}
        [d_1\cdots d_i,r]s &= d_1\cdots d_irs-rd_1\cdots d_is\\
        &= d_1\cdots d_{i-1}rd_is+d_1\cdots d_{i-1}[d_i,r]s-rd_1\cdots d_is\\
        &= \left([d_1\cdots d_{i-1},r]d_i+d_1\cdots d_{i-1}[d_i,r]\right)s.
    \end{align*}
    The term in parentheses, by the induction step, lives in $\Delta^{i-1}(R)$,
    and hence $[\Delta^i(R),r]\subset\Delta^{i-1}(R)$, as desired.
\end{proof}

\begin{example}[Weyl algebra]
    % TODO write this
    Define the Weyl algebra and show that in this case the two algebras are
    isomorphic.
\end{example}

\begin{lemma}
    The inclusion $\Delta(R)\subset D(R)$ induces an isomorphism of
    $R$-modules $\Delta^1(R)\cong D^1(R)$.
    \label{lemma:firstorder}
\end{lemma}
\begin{proof}
    By definition, $\Delta^1(R)\cong R\oplus\Der_\C R\subset D^1(R)$. Take any $\alpha\in D^1(R)$
    and let $\beta=\alpha-\alpha(1)$. By definition, $[ [\beta,r],s]=0$ for any $r,s\in R$.
    Evaluating both sides of this equation on 1, we find
    \[0 = \beta(rs)-r\beta(s)-s\beta(r),\]
    i.e. that $\beta$ acts as a derivation. Thus $\alpha=\alpha(1)+\beta\in\Delta^1(R)$.
\end{proof}

\begin{theorem}
    If $R$ is regular, then the inclusion $\Delta(R)\subset D(R)$ is an isomorphism.
    \label{thm:derivationiso}
\end{theorem}

Refer to the example of the Weyl algebra % TODO

\begin{example}
    The regularity condition on $R$ cannot be weakened. Take, for example, the cuspidal curve,
    $R=\C[x,y]/(y^2-x^3)$. The Jacobian condition\sidenote{Hartshorne I.5} reveals that $\Specm R$ has a
    singularity at the point $(0,0)$: $(-3x^2, 2y)|_{(0,0)}=0$. We now show that the inclusion
    $\Delta(R)\hookrightarrow D(R)$ is not surjective. Let us first compute $\Der_\C R$.
    Denote $S=\C[x,y]$ and $J=(y^2-x^3)\subset S$ so that $R=S/J$, with $q:S\to R$ the quotient map.
    If $d\in\Der_\C(S/J)$ with $d(J)\subset J$, it descends to a map $\tilde d:S/J\to S/J$ via
    \[\tilde d(q(s))=q(d(s)).\] If we denote the submodule of all such derivations $d$ by
    $\Der^J_\C(S)\subset\Der_\C(S)$, we obtain a map $\phi:\Der^J_\C(S)\to\Der_\C(S/J)$ taking
    $d\mapsto \tilde d$, as $\tilde d$ is easily shown to be a derivation:
    \begin{align*}
        \tilde d(q(s)q(s')) &= \tilde d\left( q(ss') \right)=q(d(ss'))\\
        &= q(sd(s')+d(s)s')\\
        &= q(s)q(d(s')) + q(d(s))q(s')\\
        &= q(s)\tilde d(s') + \tilde d(s')q(s').
    \end{align*}
    Now, since $\tilde d(q(s))=0$ implies that $d(s)\in J$, for all $s\in S$, we find that
    $\ker\phi = J\Der^J_\C(S)$. In other words, $\phi$ induces an isomorphism of $S$-modules,
    \[\tilde \phi:\Der^J_\C(S)/J\Der_\C^J(S)\to\Der_\C(S/J).\]
    One checks that $\tilde\phi$ is in the obvious way an isomorphism of $R$-modules as well.

    With this isomorphism in hand, we can compute $\Der_\C\left( \C[x,y]/(y^2-x^3) \right)$.
    Note first that $\Der_\C S=S\partial_x\oplus S\partial_y$.\sidenote{Why?} Thus any $d\in\Der_\C S$ can
    be written $d=f_1(x,y)\partial_x+f_2(x,y)\partial_y$, and for $d$ to be in $\Der_\C^JS$
    we must have for any $g(x,y)\in\C[x,y]$
    \begin{align*}
        d(y^2-x^3) &= (y^2-x^3)g(x,y)\\
        -3x^2f_1(x,y)+2yf_2(x,y) &= (y^2-x^3)g(x,y).
    \end{align*}
    Up to a factor of $(y^2-x^3)$, it's clear that the only options for $d$ are
    \begin{align*}
        d_1 &= 2y\partial_x + 3x^2\partial_y\\
        d_2 &= 3y\partial_y-2x\partial_x.
    \end{align*}
    By the isomorphism above, we find that $\Der_\C(R)\cong Sd_1\oplus Sd_2$.

    Having classified the derivations of $R$, we now construct a differential operator
    $P\in D(R)$ not in $\Delta(R)$. Let $L$ be the fraction field of $R$. We first claim that
    \[\{P\in D(L):P(R)\subset R\}\subset D(R).\]
    Clearly $P\in D(L)$, when restricted to $R$ is a $\C$-linear homomorphism from $R$ to $R$.
    By induction, it's clear that taking commutators of $P$ with $R$ preserves the property 
    \begin{align*}
        [P,r]R &= PrR-rPR\subset R,
    \end{align*}
    which proves the claim. For computational simplicity, we now write $R=\C[t^2,t^3]$, and so
    $\Der_\C R\cong S$ is generated by $t\partial_t$ and $t^2\partial_t$.\sidenote{This follows
    from the chain rule.} Consider the differential operator $Q\in D(L)$ given by
    \[Q = t\partial_t^2-\partial_t.\]
    Writing any element of $R$ as a (finite) sum $\sum_i c_it^{2a_i+3b_i}$, we note that,
    if $b_i>0$,
    \begin{align*}
        Q(t^{2a_i+3b_i}) &= (2a_i+3b_i)(2a_i+3b_i-2)t^{2a_i+3b_i-1}\\
        &= (2a_i+3b_i)(2a_i+3b_i-2)t^{2(a_i+1)+3(b_i-1)},
    \end{align*}
    which is in $R$. If $b_i=0$, we have,
    \begin{align*}
        Q(t^{2a_i}) &= 4a_i(a_i-1)t^{2a_i-1}\\
        &= 4a_i(a_i-1)t^{2(a_i+1)-3},
    \end{align*}
    which is in $R$. Hence $Q(R)\subset R$, so $Q\in D(R)$. Finally, we note that $Q$
    cannot be generated by $t\partial_t$ and $t^2\partial_t$\sidenote{why?}.
    Hence $Q\subset D(R)$ but $Q\not\subset\Delta(R)$.
\end{example}

\subsection{Proof of Theorem \ref{thm:derivationiso}}

\begin{lemma}
    Let $L$ be an extension field of $\C$ and $K$ be an algebraic extension of $L$. If
    $N$ is a $K$-module then any $f\in\Diff_L(L,N)$ has at most one extension to a
    differential operator in $\Diff_K(K,N)$.
    \label{lemma:hart1}
\end{lemma}
\begin{proof}
    Suppose we have two extensions $g,g'\in\Diff_K(K,N)$ of $f$, i.e. $g|_L=g'|_L=f$.
    Now $h=g-g'$ is clearly zero on $L$. 
    We show that any differential operator that is zero on $L$ is zero (on $K$) by induction
    on the order of $h$. Suppose first $h$ has order $i\leqslant 1$ and is zero on $L$.
    Then by an argument analogous to the proof of Lemma \ref{lemma:firstorder}, we
    find that $h\in\Der_\C(K,N)$ (the term in $K$ vanishes as $h(1)=0$). Now, using the
    fact that $L\subset K$ is an algebraic extension, we can write for any $a\in K$
    \[a^n+l_{n-1}a^{n-1}+\cdots+l_1a+l_0=0\]
    where $l_j\in L$ and $n$ is the minimal such degree. Applying $h$ to both sides,
    we find that
    \[\left(na^{n-1}+(n-1)l_{n-1}a^{n-2}+\cdots+l_1\right)h(a)=0.\]
    Since $\deg\irr a=n$ and $K$ is a field, we find that $h(a)=0$. Moreover, $a\in K$
    was chosen arbitrarily, so we find that $h=0$. This proves the base case of our
    induction. Now suppose that all differential operators of order $\leqslant i$ that
    vanish on $L$ are zero. If $h$ is a differential operator of order $\leqslant i+1$
    and vanishes on $L$, the commutator $[h,a]$ (for any $a\in K$) is of order
    $\leqslant i$ and vanishes on $L$:\sidenote{no it doesn't!} % TODO what is wrong here?
    \[ [h,a](l) = h(al)-ah(l) = h(al) = ?\]
    and hence must be zero. In other words, $[h,a]=0$ for all $a\in K$ so $h(a)=ah(1)=0$.
    This proves the inductive argument: any differential operator that is zero on $L$
    is zero. Thus $h=g-g'=0$ and any extension of $f$ must be unique.
\end{proof}

\begin{lemma}
    Suppose that $L$ is an extension field of $\C$ and suppose that $K$ is an algebraic
    extension of $L$. If $N$ is a $K$-module, then any derivation $\Der_\C(L,N)$ extends
    to a derivation $\Der_\C(K,N)$.\sidenote{What does separability do, again?}
    \label{lemma:conrad}
\end{lemma}
\begin{proof}
    Let $d:L\to N$ be a $\C$-derivation. Now define a map $\tilde d:K\to N$ extending $d$
    as follows. For any $\alpha\in K$ with minimal polynomial $f\in L[x]$, take
    \[\tilde d(\alpha) = -\frac{f^{d}(\alpha)}{f'(\alpha)},\]
    where $f^d$ is the polynomial whose coefficients are $d$ applied to the coefficients
    of $f$.\sidenote{Finish this} % TODO finish this proof (see Cohn, Basic Algebra p. 417)
\end{proof}

\begin{corollary}
    Suppose that $L$ is an extension field of $\C$ and suppose that $K$ is an algebraic
    extension of $L$. Suppose that $f:K\to K$ is a differential operator such that $fw-wf$
    has order $\leqslant p$ for all $w$ in $L$. Then $f$ has order $\leqslant p+1$.
\end{corollary}
\begin{proof}
    We proceed by induction on $p$. Suppose $p=0$ and let $g=f - f(1)\cdot\id_K$. It is easy
    to see that $g|_L$ is a $\C$-derivation $L\to K$. Lemma ?? shows that $g$ extends to a
    $\C$-derivation $\tilde g:K\to K$ and Lemma \ref{lemma:hart1} shows that $g=\tilde g$.
    Hence $g$ is a derivation and so the order of $f$ is $\leqslant 1$.
    This proves the base case. Now suppose we have $f:K\to K$ a differential operator
    such that $[f,w]$ has order $\leqslant p+1$ for all $w\in L$. Then, for any $a\in K$,
    $[ [f,w],a]$ is of order $\leqslant p$. Applying the Jacobi identity, we find that
    $[ [f,w], a] = [ [f,a], w]$
    so $[ [f,a], w]$ is of order $\leqslant p$ for each $w\in L$. By the induction hypothesis,
    this implies that $[f,a]$ is of order $\leqslant p+1$ and thus $f$ is of order $\leqslant p+2$.
    This completes the proof.
\end{proof}

\begin{lemma}
    Let $R$ be an affine ring with $S\subset R$ a multiplicatively closed subset
    (not containing zero) and $P\in D^i(R)$ is a differential operator or order
    $\leqslant i$.\sidenote{It is enough for $R$ to be a domain.}
    Denoting the commutator $[P,r]$ by $\ad'(r)(P)$, we claim that if $a,b\in R$
    and $s,t\in S$ such that $at=bs$, then 
    \begin{equation}
        \sum_{j=0}^i(-1)^js^{-j-1}(\ad's)^j(P)(a) = \sum_{j=0}^i (-1)^jt^{-j-1}(\ad't)^j(P)(b)
        \label{eq:loc_diff}
    \end{equation}
    in the localization (under the canonical injection $R\subset S^{-1}R$).
    \label{hart:lemma2}
\end{lemma}
\begin{proof}
    We induct on the order $i$ of $P$. For $i=0$, proving the above identity amounts to
    showing that $s^{-1}P(a)=t^{-1}P(b)$, which follows immediately from the $R$-linearity
    of zeroth-order differential operators. So suppose that $P$ is of order $i\geqslant 1$.
    Invoking the induction hypothesis on $(\ad's)(P)$, we have
    \begin{align}
        \sum_{j=0}^{i-1} (-1)^js^{-j-1}(\ad's)^{j+1}(P)(a) &= \sum_{j=0}^{i-1} (-1)^jt^{-j-1}(\ad't)^j[P,s](b).
        \label{eq:hart_star}
    \end{align}
    Applying the Jacobi identity repeatedly on each term of the right hand side and using the
    fact that $[s,t]=0$, we can commute the $[\cdot, s]$ to obtain
    \begin{align*}
        \text{RHS (\ref{eq:hart_star})} &= \sum_{j=0}^{i-1} (-1)^jt^{-j-1}(\ad's)(\ad't)^j(P)(b)\\
        &= t^{-1}P(sb)-t^{-1}sP(b)-t^{-2}[P,t](sb)+t^{-2}s[P,t](b)+\\
        &\indent+ t^{-3}[ [P,t],t](sb) - t^{-3}s[ [P,t],t](b) + \cdots\\
        &= -s\cdot \text{RHS (\ref{eq:loc_diff})}+t^{-1}P(at)-t^{-2}[P,t](at)+\\
        &\indent+t^{-3}[ [P,t],t](at)-\cdots 
    \end{align*}
    We now claim that
    \[P(a)=t^{-1}P(at)-t^{-2}[P,t](at)+t^{-3}[ [P,t],t](at)-\cdots,\]
    i.e. the sum of all but the first terms in the last expression above for RHS (\ref{eq:hart_star})
    is $P(a)$. This is proved by induction: if $i=0$ then the equation holds because $t^{-1}P(at)=P(a)$
    by $R$-linearity of $P$ and all higher commutators vanish. Invoking the induction
    hypothesis on $[P,t]$ yields the equality
    \[ [P,t](a)=t^{-1}[P,t](at)-t^{-2}[ [P,t],t](at)+\cdots.\]
    Expanding the commutator on the left and multiplying both sides by $t^{-1}$ yields
    the desired result. This, together with the results above yields Eq. (\ref{eq:loc_diff}).
\end{proof}

\begin{remark}
    Explain intuitively this formula for the action of differential operators on the
    localization. % TODO understand this
\end{remark}

\begin{corollary}
    For $P$ a differential operator in $D^i(R)$, we define $S^{-1}P:S^{-1}R\to S^{-1}R$ by
    \begin{equation}
        S^{-1}P(s^{-1}a) = \sum_{j=0}^i(-1)^js^{-j-1}(\ad's)^j(P)(a).
        \label{eq:locdiff}
    \end{equation}
    Then $S^{-1}P$ is a differential operator in $D^i(S^{-1}R)$, and we obtain a map
    $D(R)\to D(S^{-1}R)$ of $R$-modules.\sidenote{filtration-wise?} This map extends to an injection
    $S^{-1}R\otimes_R D(R)\to D(S^{-1}R)$ of $S^{-1}R$-modules. If $R$ is finite-type
    over $\C$, these injections are in fact isomorphisms.
\end{corollary}
\begin{proof}
    The map $S^{-1}P$ is well-defined due to Lemma \ref{hart:lemma2}. It is easy to check
    that $S^{-1}P$ is a differential operator of order $\leqslant i$ since $P$ is a differential
    operator of order $\leqslant i$. Moreover, the above equation shows that
    $S^{-1}(rP)=r S^{-1}P$, so the map $P\mapsto S^{-1}P$ is an $R$-module homomorphism.
    Now consider the extension of this map to $s^{-1}a\otimes P\mapsto s^{-1}aS^{-1}P$, a map
    $S^{-1}R\otimes_R D(R)\to D(S^{-1}R)$ of $S^{-1}R$-modules.\sidenote{Injectivity?}
    
    Now suppose that $R$ is finite-type over $\C$. We show that
    $S^{-1}R\otimes_R D^p(R,R)\to D^p(S^{-1}R,S^{-1}R)$ is surjective.
\end{proof}

\begin{theorem}
    Let $R$ be a regular local affine ring. Then the inclusion $\Delta(R)\subset D(R)$
    is an isomorphism of filtered algebras.
    \label{thm:localcase}
\end{theorem}
\begin{proof}
    We first show that the inclusion is a surjection.
    Let $n=\dim R$ and let $\Omega$ be the module of differentials of $K$ with $d:K\to\Omega$
    the universal derivation. By the theory of regular local rings, $\Omega$ is a free $K$-module
    of rank $n$, and has a basis of the form $dx_1,\ldots, dx_n$, for $x_1,\ldots,x_n\in K$.
    Clearly $x_1,\ldots,x_n$ must be algebraically independent in $K$, else there would be
    a relation between the $dx_1,\ldots,dx_n\in\Omega$. Now define $K$-module maps $h_i:\Omega\to K$
    by $h_i(dx_j)=\delta_{ij}$ and denote the compositions $d_i = d\circ h_i:K\to K.$

    Take any $f\in D(R)$ of order $\leqslant p+1$. We claim that there exist polynomials
    $f_i\in R[y_1,\ldots,y_n]$ of degree $\leqslant p$ such that $[f,x_i]=f_i(d_1,\ldots,d_n)$.
    This is clear for $p=0$ --
    in this case $[f,x_i]\in R$ and we simply choose $f_i=[f,x_i]$. Inductively, suppose
    it is true for differential operators of order $\leqslant p+1$, and take $g\in D(R)$
    of order $\leqslant p+2$. Since $[g,x_i]$ is of order $\leqslant p+1$, the induction
    hypothesis tells us that $[[g,x_i],x_j]$ can be written as a polynomial
    $\tilde g_j(d_1,\ldots,d_n)$.\sidenote{Now what?}
\end{proof}


\subsection{Sheaves}

Having studied the basic properties of various modules of differential operators,
we now wish to make contact with some geometry. This is done by sheafifying the concepts
of the previous section.

From now on $X$ will be a smooth complex algebraic variety, with structure sheaf $\mathcal{O}_X$.

\begin{definition}
    Let $\mathcal{M},\mathcal{N}$ be $\mathcal{O}_X$-modules. We define the
    $\mathcal{O}_X$-module $\mathscr{D}(\mathcal{M},\mathcal{N})$ of $\C$-derivations
    from $\mathcal{M}$ to $\mathcal{N}$ by localizing the construction of Defintion \ref{def:derivations}.
    More explicitly, we define $\mathscr{D}(\mathcal{M},\mathcal{N})$ to be
    the sheafification of the subpresheaf of $\sHom_\C(\mathcal{M},\mathcal{N})$
    whose sections are given 
    \[U\text{ open in } X \mapsto \Diff_{\mathcal{O}_X(U)}(\mathcal{M}(U),\mathcal{N}(U)).\]
    In other words, for any $P\in\mathscr{D}(\mathcal{M},\mathcal{N})(U)$ there exists an open
    cover $\{U_i\}_{i\in I}$ such that $P|_{U_i}\in\Diff_{\mathcal{O}_X(U_i)}(\mathcal{M}(U_i),\mathcal{N}(U_i))$.

    Note that we will often write $\mathscr{D}(\mathcal{M})\equiv\mathscr{D}(\mathcal{M,M})$ and
    $\mathscr{D}_X\equiv\mathscr{D}(\mathcal{O}_X)$.
    \label{def:D_X}
\end{definition}

\begin{proposition}
    If $\mathcal{M},\mathcal{N}$ are locally free, we obtain an isomorphism
    \[\mathscr{D}(\mathcal{M},\mathcal{N})=\mathcal{N}\otimes_{\mathcal{O}_X}\mathscr{D}_X\otimes_{\mathcal{O}_X}\mathcal{M}^*.\]
\end{proposition}
\begin{proof}
    \sidenote{prove this!}
\end{proof}

\begin{lemma}
    The order of differential operators provides the $\mathcal{O}_X$-module $\mathscr{D}(\mathcal{M})$
    with a filtration, making it a filtered sheaf of rings.
    \label{lem:filter1}
\end{lemma}
\begin{proof}
    Fix $U\subset X$ open. Sections of $\mathscr{D}(\mathcal{M})(U)$ are $\C_X$-linear
    sheaf homomorphisms $\phi:\mathcal{M}|_U\to\mathcal{M}|_U$. Defining multiplication as composition
    of sections, we obtain a sheaf of rings. We give $\mathscr{D}(M)$ a filtration by specifying
    $F^k\mathscr{D}(\mathcal{M})$ to be the subsheaf consisting of morphisms which, over every affine
    open $V$, lie in $\Diff^k_{\mathcal{O}_X(V)}(\mathcal{M}(V),\mathcal{M}(V))$. It is easy to see
    that restriction maps preserve the filtration and that $\cup_kF^k\mathscr{D}(\mathcal{M})=\mathscr{D}(\mathcal{M})$.
    It remains to check that
    $F^i\mathscr{D}(\mathcal{M})\cdot F^j\mathscr{D}(\mathcal{M})\subset F^{i+j}\mathscr{D}(\mathcal{M})$.
    This follows from the filtration on $\Diff_R(M,M)\equiv\Diff_R(M)$ (for $M$ an $R$-module): see
    Lemma \ref{lem:filtration}.
\end{proof}

\begin{remark}
    The sheaf of rings $\mathscr{D}(\mathcal{M})$ is not, in general, commutative or even
    almost-commutative (that is to say, $\gr_F \mathscr{D}(\mathcal{M})$ is not commutative).
    This is due to the fact that the endomorphism ring $\Diff_R^0(M)=\End_R(M)$ need not be
    commutative.

    It is worth noting, however, that there is an alternate definition of the module
    $\Diff_R(M,N)$\sidenote{Recall Definition \ref{def:derivations}.}, in which $\Diff^0_R(M,N)$ is defined to be the image of multiplication
    by $R$ in $\Hom_R(M,N)$. In this case, one checks that $\mathscr{D}(\mathcal{M})$ is
    almost-commutative. We will not make use of this second definition.
\end{remark}

Recall that we have defined $\mathscr{D}_X\equiv\mathscr{D}(\mathcal{O}_X,\mathcal{O}_X)$.
This definition is the sheafification of the algebra $D(R)$ where $R=\mathcal{O}_X(X)$ from
the previous section. It is natural, then, to reformulate this definition in terms of the
algebra $\Delta(R)$, as below. This definition admits something akin to a coordinate description,
as we will see shortly, and is thus often much easier to work with than the abstract definition
in terms of commutators given above.

\begin{definition}
    Define $\Delta_X$ to be the sheafification of the subpresheaf of $\sHom_{\C_X}(\mathcal{O}_X,\mathcal{O}_X)$
    generated as a $\C_X$-algebra by (multiplication by) $\mathcal{O}_X$ and (derivation by)
    $\Theta_X$. Explicitly, for any open $U\subset X$, the sections of $\Delta_X(U)$ are
    the endomorphisms which are locally generated -- i.e. over an open cover $U_i$ of $U$ depending
    on the endomorphism -- by 
    $\{\tilde f,\tilde \partial\mid f\in\mathcal{O}_X(U_i),\partial\in\Theta_X(U_i)\}$
    subject to the relations
    \begin{enumerate}[(i)]
        \item $\tilde f_1+\tilde f_2=\widetilde{f_1+f_2}, \;\;\; \tilde f_1\tilde f_2=\widetilde{f_1f_2};$
        \item $\tilde \partial_1 +\tilde \partial_2=\widetilde{\partial_1+\partial_2}, \;\; [\tilde\partial_1,\tilde\partial_2]=\widetilde{[\partial_1,\partial_2]};$
        \item $\tilde f\tilde \partial=\widetilde{f\partial}, \;\;\; [\tilde\partial,\tilde f]=\widetilde{\partial(f)}$.
    \end{enumerate}
    Moreover, $\Delta_X$ has, via the degree of the polynomial in derivations, the structure of a filtered
    sheaf of rings.\sidenote{The proof of this fact is similar to that of Lemma \ref{lem:filter1}.}
    \label{def:D_X2}
\end{definition}

As defined, $\Delta_X$ is a sheafification,
which is not particularly easy to work with. The following lemma reduces the case of
sections over an affine open to an algebraic question we have already studied.

\begin{lemma}
    Let $U\subset X$ be an affine open. Then $\Delta_X(U) \cong \Delta(\mathcal{O}_X(U)).$
    \label{lem:affine2}
\end{lemma}
\begin{proof}
    Consider the ring $\Delta_X(U)$ -- a priori this consists of $\C$-linear maps
    $\mathcal{O}_X(U)\to\mathcal{O}_X(U)$ that locally live in $\Delta$.
    Hence we have an obvious inclusion $\iota:\Delta(\mathcal{O}_X(U))\hookrightarrow \Delta_X(U)$.
    We now show that this inclusion is surjective.

    Fix $P\in\Delta_X(U)$. It suffices to show that $P$ is in the algebra generated by
    $\mathcal{O}_X(U)$ and $\Theta_X(U)$. By definition, there exists an open cover
    $\{U_i\}_{i\in I}$ such that $P_i=P|_{U_i}\in\Delta(\mathcal{O}_X(U_i))$, with
    $P_i|_{U_i\cap U_j}=P_j|_{U_j\cap U_i}$. We can write uniquely $P_i=\sum_J a_{iJ}d_{iJ}$,
    where the sum is finite over multiindices for $a_{iJ}\in\mathcal{O}_X(U_i)$ and $d_{iJ}$ a
    product of derivations each in $\Theta_X(U_i)$. This is true because the tangent sheaf
    of a smooth variety is locally free of finite rank, giving us generators of $\Delta(\mathcal{O}_X(U))$,
    and because elements of $\mathcal{O}_X(U_i)$ can be commuted to the left past derivations
    using the relations of Definition \ref{def:D_X2}.
    
    Now we note that
    $\mathcal{O}_X(U)\hookrightarrow \mathcal{O}_X(U_i)$ is localization at some element
    $g_i\in\mathcal{O}_X(U)$\sidenote{We can assume this by refining the open cover
    so that it consists only of basis opens $D(g_i)$.}, it is easy to show that
    \[\Theta_X(U)=\Der_\C(\mathcal{O}_X(U))\cong\Der_\C(\mathcal{O}_X(U_i))=\Theta_X(U_i).\]
    The map to the right is extension by the quotient rule, while the map to the left is
    restriction.\sidenote{Add more detail here?}
    Thus there exists a unique $d_J$ (products of derivations in $\Theta_X(U)$) such
    that $\iota(d_J)|_{U_i}=d_{iJ}$ for all $i$.
    Applying this to $P_i$ above, we find $\sum_J a_{iJ}\iota(d_J)|_{U_i}=\sum_Ja_{iJ}d_{iJ}$.
    Now, using the gluing condition $P_i|_{U_i\cap U_j}=P_j|_{U_j\cap U_i}$,
    we find that $a_{iJ}|_{U_i\cap U_j}=a_{jJ}|_{U_j\cap U_i}$ and hence, by the sheaf
    property of $\mathcal{O}_X$, there exists an $a_J\in\mathcal{O}_X(U)$ such that
    $\iota(a_J)|_{U_i}=a_{iJ}$ for all $i$. It follows that
    \[\iota\left(\sum_Ja_Jd_J\right)\bigg|_{U_i}=\sum_Ja_{iJ}d_{iJ}\]
    for all $i\in I$. This proves the surjectivity of $\iota$.
\end{proof}

With this in hand, we can prove that $\Delta_X$ is indeed just a reformulation of
$\mathscr{D}_X$. 

\begin{theorem}
    $\mathscr{D}_X$ and $\Delta_X$ are isomorphic as filtered sheaves of rings.
    \label{thm:Dequiv}
\end{theorem}
\begin{proof}
    It suffices to show that $\mathscr{D}_X(U)\cong\Delta_X(U)$ for every affine open $U\subset X$.
    The previous lemma shows that $\Delta_X(U)\cong\Delta(\mathcal{O}_X(U))$. We claim that similarly,
    $\mathscr{D}_X(U)\cong D(\mathcal{O}_X(U))$ for $U$ open affine -- then applying Theorem \ref{thm:derivationiso} yields
    the result. 
    The proof of the claim is straightforward: we can and then simply follow the proof of Lemma
    \ref{lem:affine2} by invoking Theorem \ref{thm:derivationiso}.
    It is straightforward to check that these maps preserve filtrations.
\end{proof}

Henceforth we will simply write $\mathscr{D}_X$ for $\Delta_X$. Using this reformulation,
we obtain the following local description of $\mathscr{D}_X$.

\begin{lemma}
    For any $p\in X$, there exists an affine open neighborhood $U$ of $p$ and sections
    $x_i\in\mathcal{O}_X(U),\partial_i\in\Theta_X(U)$ (for $1\leqslant i\leqslant n=\dim X$) satisfying
    \begin{enumerate}[(i)]
        \item $[\partial_i,\partial_j]=0$, $\partial_i(x_j)=\delta_{ij}$;
        \item $\Theta_X(U)=\bigoplus_{i=1}^n\mathcal{O}_X(U)\partial_i$,
    \end{enumerate}
    with which we can write\sidenote{Why?}
    \[\mathscr{D}_X(U)=\bigoplus_{J\in\N^n}\mathcal{O}_X(U)\partial^J.\]
    We will refer to $(x_i,\partial_i)$ as an \textbf{(\'etale) coordinate system} on $U$
    (where $U$ is always taken to be affine).
\end{lemma}
\begin{proof}
    Since $X$ is smooth, the stalk $\mathcal{O}_{X,p}$ is a regular local ring of dimension $n$.
    Then the maximal ideal $\fr m_p\subset \mathcal{O}_{X,p}$ is generated by $n$ elements, call them
    $x_1,\ldots,x_n\in\fr m_p$. Moreover, $\Omega^1_{X,p}$ is a free $O_{X,p}$-module generated
    by $dx_1,\ldots, dx_n$.\sidenote{explain this} Thus there exists an affine open neighboorhood
    $U$ of $p$ such that $\Omega_X(U)$ is a free $\mathcal{O}_X(U)$-module with basis
    $dx_1,\ldots,dx_n$.\sidenote{why?} Fixing the dual basis $\partial_1,\ldots,\partial_n\in\Theta_X(U)$
    satisfying $dx_i(\partial_j)=\delta_{ij}$, we find that $\partial_j(x_i)=\delta_{ij}$.
    Finally, since the commutator $[\partial_i,\partial_j]$ must be a section of $\Theta_X(U)$
    as well, we find that if $[\partial_i,\partial_j] = \sum_{k=1}^n c_{ij}^k\partial_k$
    for $c_{ij}^k\in\mathcal{O}_X(U)$, then
    \[c_{ij}^k=[\partial_i,\partial_j]x_k=\partial_i\partial_jx_k - \partial_j\partial_ix_k=0.\]
    This yields $[\partial_i,\partial_j]=0$, as desired.
\end{proof}

\begin{proposition}
    Let $(x_i, \partial_i)$ be a coordinate system on $U\subset X$ open affine.
    Then
    \begin{enumerate}[(i)]
        \item $F^j\mathscr{D}_X(U)=\bigoplus_{J\in\N^n}^{|J|\leqslant j}\mathcal{O}_X(U)\partial^J$ and so
            each filtered piece of $\mathscr{D}_X$ is a locally free $\mathcal{O}_X$-module of finite rank;
        \item $F^j\mathscr{D}_X\cdot F^k\mathscr{D}_X=F^{j+k}\mathscr{D}_X$;
        \item If $P\in F^j\mathscr{D}_X, Q\in F^k\mathscr{D}_X$ then $[P,Q]\in F^{j+k-1}\mathscr{D}_X$;
        \item The graded sheaf of rings 
            \[\gr\mathscr{D}_X = \bigoplus_{j=0}^\infty\gr^j\mathscr{D}_X = \bigoplus_{j=0}^\infty\frac{F^j\mathscr{D}_X}{F^{j-1}\mathscr{D}_X}\]
            associated to the filtration $F$ is a sheaf of finitely generated commutative $\mathcal{O}_X$-algebras.
    \end{enumerate}
\end{proposition}
\begin{proof}
    Property (i) follows immediately from Definition \ref{def:D_X2}: $\mathscr{D}_X$ is filtered
    by degree of the polynomials of derivations. 
    For (ii), that $F^j\mathscr{D}_X\cdot F^k\mathscr{D}_X\subset F^{j+k}\mathscr{D}_X$ is the definition
    of a filtration. The reverse inclusion is shown by noting that, by (i), the subsheaf $F^{j+k}\mathscr{D}_X$ is
    generated by up to $(j+k)$-fold products of derivations, which can be split arbitrarily into the
    sum of products of terms with orders $\leqslant j$ and $\leqslant k$ respectively.
    Property (iii) was proved locally in Lemma \ref{lem:filtration}.
    Finally, (iv) follows from (iii) and the fact that $F^1\mathscr{D}_X$ (essentially the derivations
    $\partial_i$) generates $\mathscr{D}_X$ as an $\mathcal{O}_X$-algebra.
\end{proof}

% TODO what do we do about D_X on singular varieties? What goes wrong?

\section{$\mathscr{D}_X$-modules}

With these basic constructions in our toolbelt, we now consider $\mathscr{D}_X$-modules,
which will take center stage for the rest of this thesis.


% TODO make the treatment of derivations more streamlined
%
%\begin{definition}
%    Let $F$ be the free $R$-module on symbols $dr$ for $r\in R$ and let $N$
%    be the submodule of $F$ generated by $d\lambda,d(r+s)-dr-ds,$ and $d(rs)-r(ds)-s(dr)$
%    for $\lambda\in\C$ and $r,s\in R$.
%    We denote by $\Omega=\Omega_\C(R)=F/N$ the module of \textbf{K\"ahler differentials}
%    of $R$, and by $d=d_R:R\to R\to\Omega_\C(R)$ taking $a\mapsto da$ the \textbf{universal derivation}
%    of $R$.\sidenote{Reference Matsumura or Hartshorne for derivations.} % TODO reference this
%\end{definition}
%
%\begin{lemma}\hfill
%    \begin{enumerate}[(i)]
%        \item Let $M$ be an $R$-module and $\delta\in\Der_\C(R,M)$ a derivation.
%            Then there is a unique $\phi\in\Hom_R(\Omega_\C(R),M)$ such that $\delta=\phi d$.
%        \item The map $\Hom_R(\Omega,M)\to\Der_\C(R,M)$ given by $\phi\mapsto \phi d$ is
%            an $R$-module isomorphism. Thus $\Der_\C R\cong\Hom_R(\Omega,R)=\Omega^\vee$.
%    \end{enumerate}
%    \label{lemma:universal}
%\end{lemma}
%\begin{proof}
%    % TODO finish this proof
%\end{proof}
%


